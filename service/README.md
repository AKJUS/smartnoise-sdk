# Adding dataset service calls
In order to add dataset.py service calls (to be supported by both the client and server), complete the following steps. One can also modify existing calls by following portions of the below steps.

## Adding functionality to the service:
1. Under service/dataset.py, add a function with a new name (one that matches the new api path), and takes in a dictionary.
2. Write in your functionality, operating on that dictionary as if the server has received it from the client. For example: register(dataset): dataset['dataset_name']...
3. Verify that your functionality is correct by running dataset.py with a mock dictionary, and by writing tests under tests/service. Once the additional service functionality appears operational, move on to adding a client call with the next steps.

## Swagger+autorest steps:
1. Follow the steps in the swagger readme (under openapi/readme.md) and ensure that you can regenerate the restclient from the swagger.yml file using the autorest npm package. Regenerating it once ensures that any future errors are your fault : )
2. Add a new path to the openapi/swagger.yml file. You can use one of the existing paths as a template, but make sure to modify each field and specify the api functionality carefully. Refer to online documentation for examples (https://swagger.io/docs/specification/describing-request-body/ is a good place to start) 
3. As you define your new path, make sure to add schema definition that fits your specific use case under "definitions:" in the swagger.yml file. For example, /register takes in a very specific schema, which is defined in "DatasetPutDocument".
4. Regenerate the swagger, and verify that the sdk/opendp/whitenoise/client/restclient contains your new path definition and sdk/opendp/whitenoise/client/restclient/models contains your new schema definition. (the names should be reflective of specifications from the swagger.yml file)

## Putting the two together:
Now we must link together the service functionality you wrote with the api call.

1. Navigate to sdk/opendp/whitenoise/client/__init__.py.
2. Inside __init__.py, you'll see classes for the various Clients that the service supports. If you are adding a dataset.py function, you will add a new definition under the DatasetClient class.
3. Note (Ignore if adding to existing client): if you are adding an entirely new client, you will need to make a new client class, and add a "get"-er for that class, to be called in the service module you expose.
4. Use the existing client methods as a template, and perform an additional processing to the dictionary received from the module. For example, in the case of /register, the dictionary passed in by the user is unpacked to fit the DatasetPutDocument schema specified in the swagger.
5. Make sure you call the exposed client method (which is autogenerated by autorest). For example, in the case of register, the method is called datasetregister.

## Testing
To verify a working end-to-end:
1. Start up two shells. Make sure to reinstall the sdk (according to instructions under docs/readme_sql.md), and make sure your environment has the correct dependencies. If you do not reinstall the sdk, then you will have an older version of the client, and your changes will not be activated!
2. Run service/app.py in one shell.
3. In the other shell, verify that everything is working by running an existing module. Inside your own module, you should then be able to call your new client side function with a call like so:
response = get_dataset_client().your_new_function_name(your_new_function_parameters)
Make sure to swap in a new "get"-er if you've written one, in place of get_dataset_client().